# CAMI 内部实现
内部实现文档设计内容较多，正在逐步完善中。

## 抽象机
### 基本执行逻辑
### 表达式 evaluation
### 静态数据
### 运行数据
### 虚拟内存管理
### 对象元数据管理

## 翻译器
除文本形式和二进制形式的字节码外，我们还定义了内存形式的字节码文件，且分为链接前的（未链接的）内存形式字节码和链接后的。前者的更便于进行链接操作，而后者则更符合抽象机的需求。
### 汇编
CAMI 汇编器会先进行递归下降的语法解析，执行简单的静态检查并生成未链接的内存形式字节码，若当前字节码文件类型为可执行文件或动态链接文件，汇编器会自动调用链接器链接该文件。
### 反汇编
反汇编器接收内存形式的字节码并输出文本形式的字节码，经过反汇编得到的字节码文件可被再次汇编且不丢失信息。
### 链接
CAMI 支持将一个或多个对象文件链接为一个对象文件或可执行文件或动态链接文件。
#### 链接为对象文件
将多个对象文件链接为一个对象文件的过程涉及如下操作：
+ 链接各个对象文件的属性
+ + 确定链接后文件的模块名或入口函数
+ + 将所有对象文件需要静态链接的文件名合并并去重后，再去除当前参与链接的所有文件名
+ + 将所有对象文件需要动态链接的文件名合并并去重
+ 丢弃所有对象文件的注释节
+ 将所有对象文件的对象、函数节简单合并在一起
+ 对字符串字面量去重，并进行重定向
+ 将所有对象文件中出现的类型和常量合并在一起并去重

#### 链接为动态链接文件
将多个对象文件链接为一个对象文件的过程涉及如下操作：
+ 将多个对象文件链接为一个对象文件
+ 重排列得到的对象文件的函数和对象节，在不改变相对位置的情况下，使相同段的函数或对象排列在一起
+ 重定向函数字节码中的符号信息，将符号转换为数字
+ 修正函数和对象的地址

#### 链接为可执行文件
链接器会先将输入链接为对象文件，插入启动函数，并执行和“链接为动态链接文件”同样的操作（重排列、重定向和修正地址）。其中，启动函数的第一条指令是 CAMI 启动后运行的第一条指令。启动函数依次调用所有初始化函数、线程初始化函数和入口函数后执行停机指令。

